<html>
<head>
    <style>

    * {
      font-family: 'Montserrat', sans-serif
    }

    body {
      background-color: #1d1d1d;
    }

    #pm {
      border: 0;
      width: 100%;
      height: 75%;
    }

    #controls {
      display: grid;
      grid-template-columns: 0.3fr 3fr;
      grid-gap: 0.5em;
      height: 20%;
      padding: 0.5em;
    }

    #buttons {
      display: grid;
      grid-gap: 0.5em;
    }

    #buttons button {
      font-size: inherit;
      background-color: #343434;
      color: white;
      transition: background-color 0.1s linear;
      border: none;
      border-radius: 10px;
      padding: 0.45em 0.35em;
      cursor: pointer;
    }

    #buttons button:hover {
      background-color: #4a4a4a
    }

    .io-container textarea {
      width: 100%;
      height: 100%;

      font-family: monospace;
      padding: 0.5em;
      border: none;
      resize: none;
      color: white;
      background-color: #343434;
      overflow: auto;
      white-space: pre;
    }

    .io-container {
        display: flex;
        flex-direction: column;
    }

    .io-container div {
      color: white;
    }

    </style>
</head>
<body>
    <script src="gant_generator.js"></script>
    <script src="./mermaid.min.js"></script>
    <script defer>
        mermaid.initialize({ startOnLoad: true });
        async function renderMermaid(graphDefinition) {
          const id = 'mermaid-' + Date.now();
    
          const { svg } = await mermaid.render(id, graphDefinition);
    
          return svg;
        }
        let defaultSpecification;

        const load = async (path) => fetch(path).then((response) => response.json())

        // load('./gantt-specification.json')
        //   .then((data) => {
        //     data.metadata.notifyWhenChanged = true;
        //     defaultSpecification = data;
        //     console.log('Default specification loaded.');
        //   });


        const logJson = (containerId, content) => {
          document.getElementById(containerId).innerHTML = JSON.stringify(content, null, 4);
        };

        // Pipeline Manager communication

        let PM;
        window.addEventListener('load', () => {
          PM = document.getElementById('pm');
          sendPM({ method: 'register_external_frontend' });
          fetch('./gantt-specification.json')
          .then((response) => response.json())
          .then((data) => {
              console.log('Default specification loaded.');
              defaultSpecification = data;
              sendPM({ method: "specification_change", params: { specification: defaultSpecification } });
              console.log(defaultSpecification);
            });

          ['frontend-endpoint-responses', 'external-endpoint-requests']
            .map((id) => document.getElementById(id))
            .forEach((e) => {
                e.addEventListener('focus', (ev) => ev.target.blur());
                e.addEventListener('drop', (ev) => ev.preventDefault());
            });
          
        });
        const sendPM = (data) => PM.contentWindow.postMessage(data);
        const createJSONRPCResponse = (id, response) => ({ jsonrpc: "2.0", id, result: response });

        window.addEventListener('message', (event) => {
          const data = event.data;
          if (data.method !== undefined) {
            const response = handleExternalRequest(data);
            sendPM(createJSONRPCResponse(data.id, response));
          } else {
            renderMermaid(generateGanttChart(data)).then((svg) => {
              document.getElementById('frontend-endpoint-responses').innerHTML = svg;
            });
          }
        });

        // Frontend requests

        const getInput = () => JSON.parse(document.getElementById('input').value);

        const graph_get = () => sendPM({ method: 'graph_get' });
        const specification_change = () => sendPM({ method: 'specification_change', params: { specification: getInput() } });
        const graph_change = () => sendPM({ method: 'graph_change', params: { dataflow: getInput() } });
        const any_request = () => sendPM(getInput());

        // External requests

        const handleExternalRequest = (request) => {
          const { method } = request;
          logJson('external-endpoint-requests', request)

          let response;
          switch (method) {
            case 'specification_get':
              response = { type: 0, content: defaultSpecification };
              break;
            case 'app_capabilities':
              response = {};
              break
            case 'frontend_on_connect':
              console.log('Connected to external application frontend.');
              response = null;
              break
            case 'dataflow_run':
              break
            case 'dataflow_import':
              const { params: { external_application_dataflow } } = request;
              response = { type: 0, content: JSON.parse(external_application_dataflow) }
              break
            case 'dataflow_export':
              const { params: { dataflow } } = request;
              response = { type: 0, content: dataflow, filename: 'pipeline.json' }
              break;
            default:
              response = null;
          }

          return response;
        };
    </script>
    <div class="wrapper">
        <iframe id="pm" src="/pipeline-manager?spec=gantt-specification.json"></iframe>
        <div>
            <div id="controls">
                <div id="buttons">
                    <button onclick="graph_get()">Get graph</button>
                    <button onclick="specification_change()">Set specification</button>
                    <button onclick="graph_change()">Set graph</button>
                    <button onclick="any_request()">Handle provided request</button>
                </div>
                <div class="io-container">
                    <pre class="mermaid" id="frontend-endpoint-responses">

                    </pre>
                    <!-- <textarea id="frontend-endpoint-responses" readonly">Make a request.</textarea> -->
            </div>
        </div>
    </div>
</body>
</html>
